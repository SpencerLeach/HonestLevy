# GothamClean: De-Clickbait Chrome Extension for GothamChess

## Overview

A Chrome extension that replaces GothamChess's clickbait YouTube titles with accurate, descriptive titles generated by AI from video transcripts. Titles are pre-generated and stored in a JSON file hosted on GitHub, so the extension is a simple lookup with zero latency for users.

Think Northernlion's title style: `[Tag] Descriptive title that tells you what the video is`.

---

## Architecture

```
┌─────────────────────────────────────────────────┐
│              GitHub Repository                   │
│                                                  │
│  ┌──────────────┐     ┌──────────────────────┐  │
│  │ titles.json   │     │ GitHub Actions (cron) │  │
│  │ {videoId:     │◄────│ runs every 6 hours    │  │
│  │  cleanTitle}  │     │                       │  │
│  └──────┬───────┘     └──────────┬───────────┘  │
│         │                        │               │
│         │              ┌─────────▼──────────┐   │
│         │              │ generate_titles.py   │   │
│         │              │ 1. Check RSS feed    │   │
│         │              │ 2. Pull transcript   │   │
│         │              │ 3. Send to Haiku     │   │
│         │              │ 4. Update JSON       │   │
│         │              └─────────────────────┘   │
└─────────┼───────────────────────────────────────┘
          │
          │  fetches raw JSON via GitHub Pages / raw URL
          │
┌─────────▼───────────────────────────────────────┐
│           Chrome Extension                       │
│                                                  │
│  content_script.js                               │
│  - MutationObserver watches for video cards      │
│  - Extracts video IDs from href attributes       │
│  - Looks up clean title from cached JSON         │
│  - Replaces title text in DOM                    │
│                                                  │
│  background.js                                   │
│  - Fetches titles.json on install + periodically │
│  - Stores in chrome.storage.local                │
│                                                  │
└─────────────────────────────────────────────────┘
```

---

## Component 1: Title Generation Pipeline (`/pipeline/`)

### `generate_titles.py`

**Purpose:** Fetch new GothamChess videos, pull transcripts, generate clean titles with Claude Haiku, and update `titles.json`.

**Dependencies:**
- `youtube-transcript-api` — pulls auto-generated captions (no API key needed)
- `anthropic` — Claude API client
- `feedparser` — parse YouTube RSS feed
- `requests` (stdlib-adjacent, but include anyway)

**Logic:**

```
1. Load existing titles.json
2. Fetch RSS feed: https://www.youtube.com/feeds/videos.xml?channel_id=UCQHX6ViZmPsWiYSFAyS0a3Q
3. For each video ID in the feed:
   a. Skip if already in titles.json
   b. Pull transcript via youtube-transcript-api
      - Grab first ~500 words (enough to identify topic)
      - If transcript unavailable, fall back to RSS title + description
   c. Send to Claude Haiku with the prompt (see below)
   d. Add to titles.json: { "videoId": { "clean_title": "...", "tag": "...", "original_title": "..." } }
4. Write updated titles.json
5. Git commit and push (handled by GitHub Actions)
```

**Error handling:**
- If transcript pull fails for a video, log it and skip — don't block the whole run
- If Claude API fails, retry once, then skip
- If a video has no transcript AND no useful description, store a fallback title like `[GothamChess] {original_title}` — still better than nothing, and it can be manually corrected later

### `backfill.py`

**Purpose:** One-time script to process Levy's entire back catalog (~2,000+ videos).

**Logic:**
- Use the YouTube Data API (v3) to paginate through all uploads on the channel
  - This requires a YouTube API key (free, generous quota)
  - RSS only gives the latest 15 videos, so we need the API for backfill
- For each video, same flow as above: transcript → Haiku → store
- Rate limit: add a small delay between API calls to stay within quota
- Process in batches, save progress after each batch so it can resume if interrupted
- Estimated cost: ~2,000 videos × ~500 input tokens + ~30 output tokens per call at Haiku pricing ≈ $2–4 total

### `titles.json` schema

```json
{
  "dQw4w9WgXcQ": {
    "clean_title": "[Recap] Carlsen vs Firouzja at Norway Chess: Sicilian Najdorf",
    "tag": "Recap",
    "original_title": "THIS DESTROYED MAGNUS.",
    "generated_at": "2025-02-27T12:00:00Z"
  },
  "abc123xyz": {
    "clean_title": "[Guess the Elo] Subscriber Games 800-1200",
    "tag": "Guess the Elo",
    "original_title": "Chess Is a Joke. This is Why.",
    "generated_at": "2025-02-27T12:00:00Z"
  }
}
```

Keep `original_title` so we can debug and so users can toggle between clean/original if we add that feature later.

---

## Component 2: Claude Haiku Prompt

This is the core quality driver. Store this as a separate file (`prompt.txt`) so it's easy to iterate on.

### System Prompt

```
You are a video title rewriter for the YouTube channel GothamChess (Levy Rozman, chess IM). Given the original clickbait title and a transcript excerpt, generate a short, accurate, descriptive title that tells viewers what the video is actually about.

Your output must be a JSON object with two fields:
- "tag": one of the category tags below
- "title": the descriptive title (max 55 characters, not including the tag)

CATEGORY TAGS (pick exactly one):
- Recap — tournament or notable game analysis/recap
- Lesson — teaching an opening, tactic, endgame, or concept
- Guess the Elo — his series reviewing subscriber games and guessing ratings
- Road to GM — his personal journey to earn the Grandmaster title
- Subscriber Games — reviewing viewer-submitted games (not Guess the Elo format)
- How to Lose — his "How to Lose at Chess" series
- News — chess world news, drama, announcements
- Challenge — playing with unusual rules, bets, or constraints
- Collab — playing or talking with another creator or celebrity
- Chatbot Chess — AI chatbots playing chess
- Tournament — Levy playing in a tournament (not recapping someone else's)
- Review — reviewing a chess product, app, or book
- Misc — only if nothing else fits

TITLE RULES:
- Name specific players, openings, events, and ratings when the transcript mentions them
- Use standard chess terminology (e.g., "Sicilian Najdorf" not "that aggressive opening")
- For recaps: prefer "[Player] vs [Player]: [Opening or Key Theme]" format
- For Guess the Elo: mention the rating range or notable theme if clear
- For lessons: name the opening or concept being taught
- Never use: ALL CAPS, exclamation marks, "insane", "destroyed", "broke", "crazy", or vague emotional language
- Be factual and specific — this title should help someone browsing decide if they want to watch
- If the video covers multiple games, focus on the most notable one or the event name

OUTPUT FORMAT (strict JSON, nothing else):
{"tag": "Recap", "title": "Carlsen vs Firouzja at Norway Chess: Sicilian Najdorf"}
```

### User Prompt Template

```
Original title: {original_title}

Transcript excerpt (first ~500 words):
{transcript_text}

Generate the clean title JSON.
```

---

## Component 3: GitHub Actions Workflow (`.github/workflows/update_titles.yml`)

```yaml
name: Update GothamChess Titles

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger for testing

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r pipeline/requirements.txt

      - name: Run title generator
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: python pipeline/generate_titles.py

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add titles.json
          git diff --staged --quiet || git commit -m "Update titles $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push
```

**Secrets needed:**
- `ANTHROPIC_API_KEY` — for Claude Haiku calls

**Optional (for backfill only):**
- `YOUTUBE_API_KEY` — for paginating the full channel history. Not needed for the cron job since RSS covers new uploads.

---

## Component 4: Chrome Extension (`/extension/`)

### File Structure

```
extension/
├── manifest.json
├── background.js
├── content_script.js
├── popup.html        # Simple toggle on/off + stats
├── popup.js
├── styles.css        # Minimal styling for modified titles
└── icons/
    ├── icon16.png
    ├── icon48.png
    └── icon128.png
```

### `manifest.json`

```json
{
  "manifest_version": 3,
  "name": "GothamClean",
  "version": "1.0.0",
  "description": "Replaces GothamChess clickbait titles with accurate, descriptive ones.",
  "permissions": ["storage"],
  "host_permissions": ["https://www.youtube.com/*"],
  "background": {
    "service_worker": "background.js"
  },
  "content_scripts": [
    {
      "matches": ["https://www.youtube.com/*"],
      "js": ["content_script.js"],
      "css": ["styles.css"],
      "run_at": "document_idle"
    }
  ],
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  },
  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}
```

### `background.js`

**Purpose:** Fetch and cache the titles.json mapping.

```
- On install: fetch titles.json from GitHub raw URL, store in chrome.storage.local
- Every 6 hours (via chrome.alarms): re-fetch titles.json to pick up new titles
- Respond to messages from content_script asking for title lookups
```

**The JSON URL:**
`https://raw.githubusercontent.com/{user}/{repo}/main/titles.json`

Or use GitHub Pages for a cleaner URL. Either works.

### `content_script.js`

**Purpose:** Detect GothamChess video cards on the page and replace titles.

**Key challenges:**
- YouTube is a Single Page Application — pages don't fully reload on navigation
- Video cards are dynamically loaded as you scroll
- Need to detect the GothamChess channel specifically (don't replace other creators' titles)

**Logic:**

```
1. On page load, request the cached title mapping from background.js

2. Create a MutationObserver watching the main content area for new nodes

3. When video cards appear (or on initial load), for each one:
   a. Check if it's a GothamChess video:
      - Look for channel name text "GothamChess" in the card's metadata
      - OR check the channel link href contains "@GothamChess" or the channel ID
   b. Extract the video ID from the thumbnail/title link href
      - YouTube links contain /watch?v=VIDEO_ID or /shorts/VIDEO_ID
   c. Look up video ID in the cached mapping
   d. If found, replace the title text element's textContent with the clean title
   e. Optionally add a small visual indicator (subtle border or icon) so users
      know the title has been cleaned

4. Handle YouTube's SPA navigation:
   - Listen for yt-navigate-finish events (YouTube's custom navigation event)
   - Re-scan the page on each navigation
```

**DOM selectors (these may need updating as YouTube changes):**

YouTube video cards use a structure roughly like:
- `ytd-rich-item-renderer` — video cards on the home/channel page
- `ytd-video-renderer` — video cards in search results
- `ytd-compact-video-renderer` — sidebar/suggested videos
- Title element: `#video-title` inside these renderers
- Channel name: `ytd-channel-name` or `#channel-name` inside the card
- Video link: `a#video-title-link` or `a#thumbnail` with href containing video ID

**Important:** Don't hardcode these too tightly. Use fallback selectors and test across YouTube page types (home, search, channel page, watch page sidebar, subscriptions).

### `popup.html` / `popup.js`

Simple popup with:
- Toggle switch: enable/disable the extension
- Stats: "X titles replaced this session"
- Link to the GitHub repo
- "Show original title" toggle (swaps back to clickbait if user wants)

### `styles.css`

Minimal. Maybe:
- A tiny indicator (dot or icon) next to replaced titles so users know it's been cleaned
- Keep it subtle — the goal is to feel native

**Optional enhancement:** Color-code the tags. Like `[Lesson]` in blue, `[Guess the Elo]` in orange, etc. This would make browsing the channel page feel like a well-organized library.

---

## Development Order

### Phase 1: Pipeline MVP
1. Write `generate_titles.py` with RSS feed parsing + transcript pulling + Haiku calls
2. Test on 5-10 recent videos manually, iterate on the prompt
3. Run `backfill.py` on the full channel
4. Set up GitHub Actions cron

### Phase 2: Extension MVP
1. Build the Chrome extension with basic title replacement
2. Test on YouTube channel page, search results, home page, and watch page sidebar
3. Handle YouTube SPA navigation properly
4. Add the popup with toggle

### Phase 3: Polish
1. Add tag color coding in the extension
2. Add "show original title" hover/toggle
3. Chrome Web Store submission
4. Post to r/chess and r/anarchychess for feedback

### Phase 4: Community (stretch)
1. Add a way for users to suggest corrections to titles
2. Simple Google Form → GitHub Issue pipeline, or a lightweight web form
3. Periodically review suggestions and manually update titles.json

---

## Key Technical Notes

### YouTube Video ID Extraction

Video IDs are 11 characters. Extract from URLs like:
- `https://www.youtube.com/watch?v=dQw4w9WgXcQ`
- `https://youtu.be/dQw4w9WgXcQ`
- `/watch?v=dQw4w9WgXcQ&list=...` (strip query params after ID)

Regex: `/[?&]v=([a-zA-Z0-9_-]{11})/` or `/youtu\.be\/([a-zA-Z0-9_-]{11})/`

### GothamChess Channel ID

`UCQHX6ViZmPsWiYSFAyS0a3Q`

RSS feed: `https://www.youtube.com/feeds/videos.xml?channel_id=UCQHX6ViZmPsWiYSFAyS0a3Q`

### Transcript Fallbacks

`youtube-transcript-api` can fail if:
- Video has no auto-generated captions (rare for English videos)
- Video is age-restricted or private
- YouTube rate limits the request

Fallback chain:
1. Auto-generated English transcript
2. Manual English captions (if available)
3. RSS feed title + description only (send to Haiku with a note that there's no transcript)
4. Skip and log — fill in manually later

### Chrome Extension Testing

- Load unpacked extension via `chrome://extensions` with Developer Mode on
- Test on: youtube.com home page, /channel/GothamChess, search results for "gothamchess", watch page sidebar recommendations, subscriptions page
- YouTube frequently tweaks their DOM — build selectors to be resilient

---

## File Tree for the Repo

```
gothamclean/
├── README.md
├── LICENSE
├── titles.json
│
├── pipeline/
│   ├── requirements.txt        # anthropic, youtube-transcript-api, feedparser
│   ├── generate_titles.py      # Cron job: RSS → transcript → Haiku → JSON
│   ├── backfill.py             # One-time: full channel history via YouTube API
│   └── prompt.txt              # Claude system prompt (single source of truth)
│
├── extension/
│   ├── manifest.json
│   ├── background.js
│   ├── content_script.js
│   ├── popup.html
│   ├── popup.js
│   ├── styles.css
│   └── icons/
│       ├── icon16.png
│       ├── icon48.png
│       └── icon128.png
│
└── .github/
    └── workflows/
        └── update_titles.yml
```

---

## Cost Estimate

| Item | Cost |
|------|------|
| Backfill ~2,000 videos via Haiku | ~$2–4 one-time |
| Daily new videos (1-2/day) via Haiku | ~$0.02–0.03/month |
| GitHub Actions | Free (well under 2,000 min/month) |
| GitHub Pages / raw hosting | Free |
| Chrome Web Store developer fee | $5 one-time |
| **Total ongoing** | **~$0.03/month** |

---

## Name Ideas

- **GothamClean** — clean + Gotham, straightforward
- **De-Levy-ered** — pun on "delivered" + Levy
- **Gotham Decoded** — decoding the clickbait
- **CleanChess** — simple, generic enough to expand later
